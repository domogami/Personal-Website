"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _assign = _interopRequireDefault(require("@babel/runtime/core-js/object/assign"));

var _react = _interopRequireDefault(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _reactRouterDom = require("react-router-dom");

var _jsxFileName = "/Users/mike/dev/gatsby-v2/packages/gatsby-link/src/__tests__/index.js";

var getInstance = function getInstance(props, pathPrefix) {
  if (pathPrefix === void 0) {
    pathPrefix = "";
  }

  (0, _assign.default)(global.window, {
    __PATH_PREFIX__: pathPrefix
  });
  var context = {
    router: {
      history: {}
    }
  };

  var Link = require("../").default;

  return new Link(props, context);
};

var getPush = function getPush() {
  (0, _assign.default)(global.window, {
    ___push: jest.fn()
  });
  return require("../").push;
};

var getReplace = function getReplace() {
  (0, _assign.default)(global.window, {
    ___replace: jest.fn()
  });
  return require("../").replace;
};

var getWithPrefix = function getWithPrefix(pathPrefix) {
  if (pathPrefix === void 0) {
    pathPrefix = "";
  }

  (0, _assign.default)(global.window, {
    __PATH_PREFIX__: pathPrefix
  });
  return require("../").withPrefix;
};

describe("<Link />", function () {
  it("does not fail to initialize without --prefix-paths", function () {
    expect(function () {
      getInstance({});
    }).not.toThrow();
  });
  describe("path prefixing", function () {
    it("does not include path prefix", function () {
      var to = "/path";
      var pathPrefix = "/blog";
      var instance = getInstance({
        to: to
      }, pathPrefix);
      expect(instance.state.to.pathname).toEqual(to);
    });
  });
  describe("the location to link to", function () {
    global.window.___loader = {
      enqueue: jest.fn()
    };
    it("accepts to as a string", function () {
      var location = "/courses?sort=name";
      var node = document.createElement("div");

      var Link = require("../").default;

      _reactDom.default.render(_react.default.createElement(_reactRouterDom.MemoryRouter, {
        __source: {
          fileName: _jsxFileName,
          lineNumber: 68
        },
        __self: this
      }, _react.default.createElement(Link, {
        to: location,
        __source: {
          fileName: _jsxFileName,
          lineNumber: 69
        },
        __self: this
      }, "link")), node);

      var href = node.querySelector("a").getAttribute("href");
      expect(href).toEqual(location);
    });
    it("accepts a location \"to\" prop", function () {
      var location = {
        pathname: "/courses",
        search: "?sort=name",
        hash: "#the-hash",
        state: {
          fromDashboard: true
        }
      };
      var node = document.createElement("div");

      var Link = require("../").default;

      _reactDom.default.render(_react.default.createElement(_reactRouterDom.MemoryRouter, {
        __source: {
          fileName: _jsxFileName,
          lineNumber: 91
        },
        __self: this
      }, _react.default.createElement(Link, {
        to: location,
        __source: {
          fileName: _jsxFileName,
          lineNumber: 92
        },
        __self: this
      }, "link")), node);

      var href = node.querySelector("a").getAttribute("href");
      expect(href).toEqual("/courses?sort=name#the-hash");
    });
    it("resolves to with no pathname using current location", function () {
      var location = {
        search: "?sort=name",
        hash: "#the-hash"
      };
      var node = document.createElement("div");

      var Link = require("../").default;

      _reactDom.default.render(_react.default.createElement(_reactRouterDom.MemoryRouter, {
        initialEntries: ["/somewhere"],
        __source: {
          fileName: _jsxFileName,
          lineNumber: 112
        },
        __self: this
      }, _react.default.createElement(Link, {
        to: location,
        __source: {
          fileName: _jsxFileName,
          lineNumber: 113
        },
        __self: this
      }, "link")), node);

      var href = node.querySelector("a").getAttribute("href");
      expect(href).toEqual("/somewhere?sort=name#the-hash");
    });
  });
  it("push is called with correct args", function () {
    getPush()("/some-path");
    expect(global.window.___push).toHaveBeenCalledWith("/some-path");
  });
  it("replace is called with correct args", function () {
    getReplace()("/some-path");
    expect(global.window.___replace).toHaveBeenCalledWith("/some-path");
  });
});
describe("withPrefix", function () {
  describe("works with default prefix", function () {
    it("default prefix does not return \"//\"", function () {
      var to = "/";
      var root = getWithPrefix()(to);
      expect(root).toEqual(to);
    });
    it("respects path prefix", function () {
      var to = "/abc/";
      var pathPrefix = "/blog";
      var root = getWithPrefix(pathPrefix)(to);
      expect(root).toEqual("" + pathPrefix + to);
    });
  });
});